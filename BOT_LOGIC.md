# Логика работы бота Псич

## Общая схема работы

```
┌─────────────────┐
│ Игрок пишет    │
│ сообщение       │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Фильтрация:     │
│ - Не пустое?    │
│ - Не от бота?   │
│ - Не в муте?    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Сохранение в   │
│ историю +      │
│ обновление      │
│ профиля         │
└────────┬────────┘
         │
         ▼
    ┌─────────┐
    │ Есть    │
    │ триггер │
    │ "Псич"? │
    └────┬────┘
         │
    ┌────┴────┐
    │         │
   ДА        НЕТ
    │         │
    │         ▼
    │    ┌──────────────┐
    │    │ Шанс 5%?     │
    │    │ Длина >= 10? │
    │    └──────┬───────┘
    │           │
    │      ┌────┴────┐
    │      │         │
    │     ДА        НЕТ
    │      │         │
    │      │         └──► Игнорируем
    │      │
    └──────┴──────┐
                 │
                 ▼
         ┌───────────────┐
         │ AI решает:    │
         │ стоит ли      │
         │ отвечать?     │
         └───────┬───────┘
                 │
            ┌────┴────┐
            │         │
           ДА        НЕТ
            │         │
            │         └──► Игнорируем
            │
            ▼
    ┌───────────────┐
    │ Генерация     │
    │ ответа через  │
    │ AI            │
    └───────┬───────┘
            │
            ▼
    ┌───────────────┐
    │ Разбивка на   │
    │ части (256    │
    │ символов)     │
    └───────┬───────┘
            │
            ▼
    ┌───────────────┐
    │ Отправка в    │
    │ игру + Discord│
    └───────────────┘
```

## Детальная логика

### 1. Обработка входящих сообщений

**Триггер "Псич":**
- Ищется слово "Псич" или "psych" в сообщении (регистронезависимо)
- Если найдено → **100% ответ**
- Обрабатывается асинхронно (не блокирует чат)

**Спонтанный ответ:**
- Проверка: длина сообщения >= 10 символов
- Случайный шанс: 5% (настраивается в `config.yml`)
- Если шанс выпал → AI анализирует последние 15 сообщений
- AI решает: "Стоит ли отвечать на это сообщение?"
- Если AI решил ответить → генерируем ответ

### 2. Генерация ответа

**Сбор контекста:**
- История чата: последние 20 сообщений
- Профиль игрока:
  - Репутация (0-100)
  - Факты о игроке
  - Отношения с ботом
- Системный промпт (личность бота)
- Время на сервере

**Выбор AI провайдера:**
1. **Groq** (llama-3.3-70b) - основной
2. **Gemini** (gemini-2.0-flash-exp) - резерв
3. **Gemma** (gemma-3-27b) - простой fallback
4. **Groq-Simple** (llama-3.1-8b) - простой fallback
5. **DeepSeek** - последний вариант (платный)

**Fallback логика:**
- Если провайдер недоступен → переключение на следующий
- Если лимит исчерпан → переключение на следующий
- Если все недоступны → ошибка

### 3. Отправка сообщения

**В игру:**
- Формат: `<Псич> сообщение`
- Цвет ника настраивается в конфиге
- Разбивка на части по 256 символов (лимит Minecraft)
- Задержка 100мс между частями

**В Discord (если включено):**
- Создается событие `AsyncPlayerChatEvent`
- DiscordSRV перехватывает и отправляет в Discord
- Формат: `<Псич> сообщение`

### 4. Анализ репутации

**Асинхронно после ответа:**
- Анализируются последние 5 сообщений
- AI определяет изменение репутации
- Обновляется профиль игрока
- Сохраняется в JSON

## Настройки

**В `config.yml`:**
- `chat.trigger` - триггер для прямого обращения (по умолчанию "псич")
- `chat.spontaneous-chance` - шанс спонтанного ответа (0.05 = 5%)
- `chat.context-size` - количество сообщений для анализа (15)
- `chat.min-message-length` - минимальная длина для спонтанного ответа (10)
- `chat.name-color` - цвет ника бота
- `chat.send-as-player` - отправлять как игрок (для Discord)

## Защита от зацикливания

- Сообщения, начинающиеся с `<Псич>` игнорируются
- Сообщения от бота сохраняются в историю, но не обрабатываются
- Предотвращает бесконечные ответы самому себе

